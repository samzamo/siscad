<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Pesquisar Alvo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }

    body {
      background-color: #d2f5d0;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }

    .form-wrapper {
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .form-container {
      width: 100%;
      max-width: 700px;
      background-color: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 10px #aaa;
    }

    h2, h3 {
      text-align: center;
      margin-top: 0;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #aaa;
      font-size: 16px;
    }

    button {
      background-color: #0d8df7;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      padding: 10px;
      font-size: 16px;
    }

    button:hover {
      background-color: #0092cc;
    }

    .resultado-button {
      background-color: #f08c00;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      padding: 10px;
      font-size: 15px;
      cursor: pointer;
      transition: background-color 0.3s;
      margin-bottom: 10px;
    }

    .resultado-button:hover {
      background-color: #cc7200;
    }

    .resultado, .alvo-info {
      margin-top: 30px;
      padding: 20px;
      background-color: #b4ebb4;
      border-radius: 10px;
      box-shadow: 0 0 10px #888;
    }

    .alvo-info-flex {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .alvo-info img {
      max-width: 220px;
      height: auto;
      max-height: 350px;
      object-fit: contain;
      border-radius: 12px;
      border: 2px solid #064d26;
      flex-shrink: 0;
    }

    .alvo-dados {
      flex: 1;
      min-width: 240px;
      max-width: 100%;
    }

    .alvo-dados p {
      margin: 8px 0;
    }

    .anotacoes-box {
      white-space: pre-wrap;
      background-color: #fff;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #ccc;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
    }

    @media screen and (max-width: 600px) {
      .alvo-info-flex { flex-direction: column; align-items: center; }
    }

    .centered {
      text-align: center;
    }

    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-box {
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      max-height: 95vh;
      overflow-y: auto;
      box-shadow: 0 0 12px #000;
      position: relative;
    }

    .modal-box h3 {
      margin-top: 0;
      text-align: center;
    }

    .close-button {
      background-color: #ff4c4c;
      color: white;
      font-weight: bold;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      float: right;
      margin-top: -10px;
      margin-right: -10px;
    }

    .close-button:hover {
      background-color: #cc0000;
    }
  </style>
  <script>
    function abrirModal() {
      document.getElementById("modal-edicao").style.display = "flex";
    }
    function fecharModal() {
      document.getElementById("modal-edicao").style.display = "none";
    }
  </script>
</head>
<body>

  <div class="form-wrapper">
    <div class="form-container">

      <h2>Pesquisar Alvo</h2>
      
      {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, msg in messages %}
      <div id="msg-flash" style="
        position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        background-color: #d4edda;
        color: #155724;
        font-weight: bold;
        padding: 16px 28px;
        border-radius: 12px;
        box-shadow: 0 0 10px rgba(0,0,0,0.25);
        border: 1px solid #c3e6cb;
        z-index: 9999;">
        {{ msg }}
      </div>
      <script>
        setTimeout(() => {
          const el = document.getElementById('msg-flash');
          if (el) el.style.display = 'none';
        }, 3000); // some em 3 segundos
      </script>
    {% endfor %}
  {% endif %}
{% endwith %}
      <form method="POST" style="margin-bottom: 15px;">
        <input type="text" name="termo" placeholder="nome ou vulgo" value="{{ termo }}" required>
        <input type="text" name="bairro" placeholder="bairro (opcional)" value="{{ bairro }}">
        <button type="submit">üîç pesquisar</button>
      </form>

      <form action="/menu">
        <button type="submit">üè† voltar ao menu</button>
      </form>

      {% if mensagem %}
        <p style="text-align:center; font-weight:bold; color:#a94442; background-color:#f2dede; padding:10px; border-radius:8px;">
          {{ mensagem }}
        </p>
      {% endif %}

      {% if resultados %}
        <div class="resultado">
          <h3>Resultados:</h3>
          {% for r in resultados %}
            <form method="GET">
              <input type="hidden" name="id" value="{{ r.id }}">
              <button type="submit" class="resultado-button">{{ r.nome }} ‚Äì {{ r.vulgo }}</button>
            </form>
          {% endfor %}
        </div>
      {% endif %}

      {% if alvo %}
        <div class="alvo-info">
          <h3>Alvo Selecionado</h3>
          <div class="alvo-info-flex">
            {% if alvo.foto %}
              <img src="{{ alvo.foto if alvo.foto.startswith('http') else url_for('static', filename='IMAGEM/' + alvo.foto) }}" alt="Foto do alvo">
            {% endif %}

            <div class="alvo-dados">
              <p><strong>Nome:</strong> {{ alvo.nome }}</p>
              <p><strong>Vulgo:</strong> {{ alvo.vulgo }}</p>
              <p><strong>Genitora:</strong> {{ alvo.genitora }}</p>
              <p><strong>Munic√≠pio:</strong> {{ alvo.municipio }}</p>
              <p><strong>Bairro:</strong> {{ alvo.bairro }}</p>
              <p><strong>Octopus:</strong> {{ alvo.octopus }}</p>

              <button type="button" onclick="abrirModal()">‚úèÔ∏è Alterar dados</button>

              {% if is_admin %}
                <form method="POST" action="/excluir_alvo" onsubmit="return confirm('Tem certeza que deseja excluir este alvo?')">
                  <input type="hidden" name="id" value="{{ alvo.id }}">
                  <button type="submit" style="background-color:#ff4c4c;">üóëÔ∏è excluir cadastro</button>
                </form>
              {% endif %}
            </div>
          </div>

          <div class="centered" style="margin-top: 20px;">
            <h4>Anota√ß√µes:</h4>
            <div class="anotacoes-box">{{ alvo.anotacoes }}</div>
          </div>
        </div>
      {% endif %}

    </div>
  </div>

  <!-- ü™ü MODAL DE EDI√á√ÉO FLUTUANTE UNIFICADO -->
<div id="modal-edicao" class="modal-overlay">
  <div class="modal-box">
    <button type="button" class="close-button" onclick="fecharModal()">‚ùå fechar</button>
    <h3>Editar Dados do Alvo</h3>

    {% if alvo.foto %}
    <div style="text-align:center; margin-bottom:20px;">
      <img src="{{ alvo.foto if alvo.foto.startswith('http') else url_for('static', filename='IMAGEM/' + alvo.foto) }}"
           alt="Foto atual"
           style="max-width:180px; max-height:250px; border-radius:10px; border:2px solid #0e93ec;">
      <p style="margin-top:8px; font-weight:bold;">Foto atual</p>
    </div>
    {% endif %}

    <form method="POST" enctype="multipart/form-data" action="/editar_alvo">
      <input type="hidden" name="id" value="{{ alvo.id }}">
      <input type="text" name="nome" value="{{ alvo.nome }}" placeholder="nome">
      <input type="text" name="vulgo" value="{{ alvo.vulgo }}" placeholder="vulgo">
      <input type="text" name="genitora" value="{{ alvo.genitora }}" placeholder="genitora">
      <input type="text" name="municipio" value="{{ alvo.municipio }}" placeholder="munic√≠pio">
      <input type="text" name="bairro" value="{{ alvo.bairro }}" placeholder="bairro">
      <textarea name="anotacoes" rows="10" placeholder="anota√ß√µes">[{{ now }}] 
‚§µÔ∏è Digite abaixo a nova anota√ß√£o...

{{ alvo.anotacoes }}</textarea>
      <input type="text" name="octopus" value="{{ alvo.octopus }}" placeholder="octopus">
      <input type="file" name="nova_foto" accept="image/*">
      <button type="submit">üíæ salvar altera√ß√µes</button>
    </form>
  </div>
</div>

{% if alvo and request.args.get('open_modal') %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    abrirModal();
  });
</script>
{% endif %}
</body>
</html>
